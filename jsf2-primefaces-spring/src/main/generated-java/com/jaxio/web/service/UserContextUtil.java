/*
 * (c) Copyright 2005-2013 JAXIO, http://www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to use Celerio within your company? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Template pack-jsf2-spring-conversation:src/main/java/services/UserContextUtil.p.vm.java
 */
package com.jaxio.web.service;

import static com.jaxio.web.conversation.ConversationHolder.getCurrentConversation;

import java.util.List;
import java.util.Locale;

import javax.faces.context.ExternalContext;
import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.inject.Named;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.context.annotation.Scope;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.web.servlet.LocaleResolver;

import com.jaxio.context.UserContext;
import com.jaxio.web.conversation.Conversation;

/**
 * Simple pass over to access static 'userContext'from EL.
 * Keeps also the user's preferred locale.
 *
 * @see org.springframework.security.web.authentication.AnonymousAuthenticationFilter
 */
@Named("userContext")
@Scope("session")
public class UserContextUtil {
    private Locale locale;

    @Inject
    private LocaleResolver localeResolver;

    /**
     * It is invoked from the f:view tag. 
     * It defaults to the default JSF local.
     * 
     */
    public String getLocale() {
        if (locale == null) {
            locale = FacesContext.getCurrentInstance().getApplication().getDefaultLocale();
        }
        LocaleContextHolder.setLocale(locale);
        FacesContext.getCurrentInstance().getViewRoot().setLocale(locale);
        return locale.getLanguage();
    }

    public String switchToFrench() {
        return switchToLocale(Locale.FRENCH);
    }

    public String switchToEnglish() {
        return switchToLocale(Locale.ENGLISH);
    }

    private String switchToLocale(Locale locale) {
        this.locale = locale;
        FacesContext currentInstance = FacesContext.getCurrentInstance();
        updateLocale(locale, currentInstance);
        Conversation currentConversation = getCurrentConversation();

        String viewId = currentInstance.getViewRoot().getViewId();
        if (currentConversation != null) {
            return viewId + "?faces-redirect=true&_cid_=" + currentConversation.getId() + "&_ccid_=" + currentConversation.getCurrentContext().getId();
        } else {
            return viewId + "?faces-redirect=true";
        }
    }

    /**
     * updates locale in 
     * <ul>
     * <li>{@link LocaleContextHolder} to have valid locale in current request</li>
     * <li>{@link LocaleResolver} to have valid locale in next requests (depending on localeResolver strategy)</li>
     * </ul>
     * @param locale
     * @param currentInstance
     */
    private void updateLocale(Locale locale, FacesContext currentInstance) {
        currentInstance.getViewRoot().setLocale(locale);
        ExternalContext externalContext = currentInstance.getExternalContext();
        HttpServletRequest request = (HttpServletRequest) externalContext.getRequest();
        HttpServletResponse response = (HttpServletResponse) externalContext.getResponse();
        localeResolver.setLocale(request, response, locale);
        LocaleContextHolder.setLocale(locale);
    }

    public String getUsername() {
        return UserContext.getUsername();
    }

    public boolean isAnonymousUser() {
        return UserContext.ANONYMOUS_USER.equalsIgnoreCase(getUsername());
    }

    public boolean isLoggedIn() {
        return !isAnonymousUser();
    }

    public boolean isFrench() {
        if (locale != null) {
            return "fr".equals(locale.getLanguage());
        } else {
            // just in case, but should not happen
            return "fr".equals(LocaleContextHolder.getLocale().getLanguage());
        }
    }

    public List<String> getRoles() {
        return UserContext.getRoles();
    }

    public boolean hasRole(String role) {
        return UserContext.getRoles().contains(role);
    }
}
