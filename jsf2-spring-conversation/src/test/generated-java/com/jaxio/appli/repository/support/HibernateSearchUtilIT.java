/*
 * (c) Copyright 2005-2013 JAXIO, http://www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to purchase Celerio ? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Documentation: http://www.jaxio.com/documentation/celerio/
 * Template pack-backend-jpa:src/test/java/repository/support/HibernateSearchUtilIT.p.vm.java
 */
package com.jaxio.appli.repository.support;

import static org.fest.assertions.Assertions.assertThat;
import static org.hibernate.search.jpa.Search.getFullTextEntityManager;

import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.transaction.annotation.Transactional;

import com.jaxio.appli.domain.Account;
import com.jaxio.appli.domain.Account_;
import com.jaxio.appli.repository.AccountRepository;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath*:spring/applicationContext-test.xml" })
@Transactional
public class HibernateSearchUtilIT {

    @Inject
    private AccountRepository accountRepository;

    @PersistenceContext
    private EntityManager entityManager;

    @Before
    public void buildExample() {
        accountRepository.save(jeanLouis());
        accountRepository.save(jeanMichel());
        entityManager.flush();
        getFullTextEntityManager(entityManager).flushToIndexes();
    }

    private Account jeanMichel() {
        return accountRepository.getNew() //
                .email("jmdexample@example.com") //
                .firstName("Jean-Michel") //
                .lastName("EXAMPLE") //
                .username("jmexample") //
                .password("xxx") //
                .isEnabled(true);
    }

    private Account jeanLouis() {
        return accountRepository.getNew() //
                .email("jlsample@example.com") //
                .firstName("Jean-Louis") //
                .lastName("SAMPLE") //
                .username("jlsample") //
                .password("xxx") //
                .isEnabled(true);
    }

    @Test
    public void term() {
        SearchParameters sp = new SearchParameters() //
                .term("jeaan");
        assertThat(accountRepository.find(sp)).hasSize(2);
    }

    @Test
    public void termOn() {
        SearchParameters sp = new SearchParameters() //
                .term(Account_.firstName, "louhis");
        assertThat(accountRepository.find(sp)).hasSize(1);
    }

    @Test
    public void termOnManyProperties() {
        SearchParameters sp = new SearchParameters() //
                .term(Account_.email, "sammple") //
                .term(Account_.lastName, "sammple");
        assertThat(accountRepository.find(sp)).hasSize(2);
    }

    @Test
    public void termOnManyNoMatch() {
        SearchParameters sp = new SearchParameters() //
                .term(Account_.email, "sammple") //
                .term(Account_.firstName, "sammple");
        assertThat(accountRepository.find(sp)).isEmpty();
    }

    @Test
    public void termOnWithSimilariy() {
        SearchParameters sp = new SearchParameters() //
                .searchSimilarity(0.99f) //
                .term(Account_.firstName, "louhis"); //
        assertThat(accountRepository.find(sp)).isEmpty();
    }

    @Test
    public void termOnNoMatch() {
        SearchParameters sp = new SearchParameters() //
                .term(Account_.email, "louhis");
        assertThat(accountRepository.find(sp)).isEmpty();
    }

    @Test(expected = IllegalArgumentException.class)
    public void searchOnUninedexedAttribute() {
        SearchParameters sp = new SearchParameters() //
                .searchSimilarity(0.99f) //
                .term(Account_.description, "louhis");
        accountRepository.find(sp);
    }
}